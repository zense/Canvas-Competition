<html>

<body onload="canvas.setup()">
    
    <canvas id="canvasArea1" style="position: absolute; left: 0; top: 0; z-index: 0; width:100%;height:100%"></canvas>
    <canvas id="canvasArea2" style="visibility: hidden; position: absolute; left: 0; top: 0; z-index: 0; width:100%;height:100%"></canvas>
	
    <script src="./canvas.js"></script>
</body>

</html>
<script>

    // Declare all global variables here
    
    var exitcode = 0;       //win or lose
    var running = 1;        //Game running or not
    var accuracy = 0;       
    var con = false;        //chosen the controller or not
    var whatcon = 0;        //Which controller

    var p = false;           //Playing or not
    var frame = 0;          //Frame number
    var acc = [0,0];        //accuracy
    var arrows = [];        //Arrow position
    
    var player_x = 180; 
    var player_y = 60;
    var player_vel = 10;

    var velx_arr = 10;  //Enemy vel

    var badtimer = 100; //Enemy spawn time
    var badtimer1 = 0;  //Decreaser for the Enemy Spawn Timer

    var badguys = [[canvas.width,60]];  //Position of bad guys
    var healthvalue = 200;  //Your Initial Health




    // Function which will be called repeatedly 

    //Here there are functions for rendering of images of charecthers and backgrounds
    function HealthBar(x,y,width)
    {
        canvas.drawImg("resources/images/healthbar.png",x,y,width);
    }

    function gameover(x,y)
    {
        canvas.drawImg("resources/images/gameover.png",x,y,canvas.width,canvas.height);
    }

    function youwin(x,y)
    {
        canvas.drawImg("resources/images/youwin.png",x,y,canvas.width,canvas.height);
    }


    function badBadger(x,y) {
        canvas.drawImg("resources/images/badguy.png",x,y);
    }

    
    function bullet(x,y) {
        canvas.drawImg("resources/images/bullet.png",x,y);
    }


    function player(x,y) {
        canvas.drawImg("resources/images/dude.png",x,y);
    }

    function grass(x,y) {
        canvas.drawImg("resources/images/grass.png",x,y);
    }

    function castle(x,y) {
        canvas.drawImg("resources/images/castle.png",x,y);
    }

    //Condition checks for if any of the buttons are clicked
    function StartClick(mouseX,mouseY) {
        if(mouseX>632 && mouseX<732 && mouseY>385 && mouseY<420)
            return 1;
        else
            return 0;
    }
    
    //Next page which controller you want button selection
    function KeyboardClick(mouseX,mouseY) {
        if(mouseX>532 && mouseX<632 && mouseY>385 && mouseY<420)
            return 1;
        else
            return 0;
    }
    
    //If you want mouse as controller(BBox of MOuse controller button)
    function MouseClick(mouseX,mouseY) {
        if(mouseX>832 && mouseX<932 && mouseY>385 && mouseY<420)
            return 1;
        else
            return 0;
    }
    
    // Declare custom functions here    

    
    //Creating Menu Display Page


    function menu() {
            
            // Trying to give 3D effect to text via superimposing one image over another
            canvas.setColor("silver");
            canvas.drawText(canvas.width/2 - 590, canvas.height/2 - 55,"Rabbits And Badgers Game", fontSize = 100);
            canvas.setColor("black");
            canvas.drawText(canvas.width/2 - 580, canvas.height/2 - 50,"Rabbits And Badgers Game", fontSize = 98);
            canvas.drawRectangle(canvas.width/2 - 50,canvas.height/20 + 350,100,35);
            canvas.setColor("black");

            //For hovering of mouse over the button
            if(StartClick(canvas.mouseX,canvas.mouseY))
            {
                canvas.setDrawMode("fill");
                canvas.setColor("yellow");
                canvas.drawRectangle(canvas.width/2 - 50,canvas.height/20 + 350,100,35);
                canvas.setColor("black");
            }
            else 
            {
                canvas.setDrawMode("fill");
                canvas.setColor("white");
                canvas.drawRectangle(canvas.width/2 - 50,canvas.height/20 + 350,100,35);
                canvas.setColor("black");
            }

            //For Clicking of the Start button
            if(StartClick(canvas.mouseDownX,canvas.mouseDownY))
            {
                canvas.setDrawMode("fill");
                canvas.setColor("green");
                canvas.drawRectangle(canvas.width/2 - 50,canvas.height/20 + 350,100,35);
                canvas.setColor("black");
                p = true;
            }   
            canvas.drawText(canvas.width/2 - 20,canvas.height/20 + 375,"Start", fontSize = 20);    
            canvas.mouseDownX = 0;
            canvas.mouseDownY = 0;
            canvas.setDrawMode("stroke");
            //canvas.drawText(20,20,p, fontSize = 20);
    }

    //Displayed on the start of the game
    function Objective()
    {
        canvas.setColor('rgba(100,100,100,0.8)');
        canvas.drawText(canvas.width/2 - 390, canvas.height/2 - 35,"Save your carrots and your children rabbits ", fontSize = 40);
        canvas.drawText(canvas.width/2 - 390, canvas.height/2 ,"till the timer runs out", fontSize = 30);
        
        canvas.setColor('rgba(100,100,101,0.3)');
        canvas.drawText(canvas.width/2 - 386, canvas.height/2 - 34,"Save your carrots and your children rabbits", fontSize = 39.5);
        canvas.drawText(canvas.width/2 - 390, canvas.height/2 - 1,"till the timer runs out", fontSize = 29.5);
    }

    //Controller choosing screen
    function NextScreen()
    {
        canvas.setColor('silver');
        canvas.drawText(canvas.width/2 - 590, canvas.height/2 - 55,"Choose Controls", fontSize = 100);
        canvas.setColor('black');
        canvas.drawText(canvas.width/2 - 580, canvas.height/2 - 50,"Choose Controls", fontSize = 98);
        canvas.drawRectangle(canvas.width/2 - 150,canvas.height/20 + 350,100,35);
        canvas.drawRectangle(canvas.width/2 + 150,canvas.height/20 + 350,100,35);

        canvas.setColor('black');

        //Keyboard Button Hover
        if(KeyboardClick(canvas.mouseX,canvas.mouseY))
            {
                canvas.setDrawMode("fill");
                canvas.setColor("yellow");
                canvas.drawRectangle(canvas.width/2 - 150,canvas.height/20 + 350,100,35);
                canvas.setColor("black");
            }
            else 
            {
                canvas.setDrawMode("fill");
                canvas.setColor("white");
                canvas.drawRectangle(canvas.width/2 - 150,canvas.height/20 + 350,100,35);
                canvas.setColor("black");
            }

            //Mouse Button Hover
            if(MouseClick(canvas.mouseX,canvas.mouseY))
            {
                canvas.setDrawMode("fill");
                canvas.setColor("yellow");
                canvas.drawRectangle(canvas.width/2 + 150,canvas.height/20 + 350,100,35);
                canvas.setColor("black");
            }
            else 
            {
                canvas.setDrawMode("fill");
                canvas.setColor("white");
                canvas.drawRectangle(canvas.width/2 + 150,canvas.height/20 + 350,100,35);
                canvas.setColor("black");
            }
            
            //For Clicking of the Keyboard Controller button
            if(KeyboardClick(canvas.mouseDownX,canvas.mouseDownY))
            {
                canvas.setDrawMode("fill");
                canvas.setColor("green");
                canvas.drawRectangle(canvas.width/2 - 150,canvas.height/20 + 350,100,35);
                canvas.setColor("black");
                con = true;
                whatcon = 1;
            }   
            canvas.drawText(canvas.width/2 - 140,canvas.height/20 + 375,"Keyboard", fontSize = 20);    
            canvas.setDrawMode("stroke");

            
            //For Clicking of the Mouse Controller button
            
            if(MouseClick(canvas.mouseDownX,canvas.mouseDownY))
            {
                console.log(whatcon);
                canvas.setDrawMode("fill");
                canvas.setColor("green");
                canvas.drawRectangle(canvas.width/2 + 150,canvas.height/20 + 350,100,35);
                canvas.setColor("black");
                con = true;
            }
            canvas.drawText(canvas.width/2 + 160,canvas.height/20 + 375,"Mouse", fontSize = 20);    
            canvas.setDrawMode("stroke");
    }

    //Checks if the badger has not reached your carrots or children
    function badgerUpdatePos(value, index, array) {
        return value[0] >= 64;
    }

    //Checks which badger attacked
    function badgerAttacked(value, index, array) {
        return value[0] <= 70;
    }

    //Checks if any arrow goes out of the canvas
    function arrowUpdatePos(value, index, array) {
        return (value[0] >= 0 && value[0] < canvas.width);
    }

    function main() {
        
        //If not playing display the menu
        if(!p)
        {
                menu();
        }

        //Setting up the controller
        else if(!con)
        {
            //console.log(whatcon);
            canvas.clear();
            NextScreen();
        }

        //If playing that means game is running
        
        else if(running)
         {
            //setting up the canvas with intial conditions and background
            canvas.activateDoubleBuffer();
            controller(whatcon);
            var i,j;

            //Setting up the grassy Background
            for (i = 0; i < canvas.width/100; i++) {
                for (j = 0; j < canvas.height/100; j++) {
                    grass(i*100,j*100);
                }
            }

            //Survival time
            var survivedText = Math.floor((190000-frame*timeStep*5)/60000) + ":" + Math.floor((190000-frame*timeStep*5)/1000%60);
            canvas.setDrawMode("fill");
            
            //HealthBar
            canvas.setColor("red");
            HealthBar(10,10,20);
            canvas.setColor("green");
            canvas.drawRectangle(10,10,Math.floor(healthvalue),20);
            canvas.setDrawMode("stroke");
            canvas.setColor("black");
            canvas.drawText(canvas.width-200,50,survivedText,fontSize = 40);
            
            
            //Setting up player and Castles in their intial positions
            if(whatcon == 0)
                player(canvas.mouseX,canvas.mouseY);
            else
                player(player_x,player_y);
            castle(0,30);
            castle(0,130);
            castle(0,230);
            castle(0,330);
            castle(0,430);
            castle(0,530);
            
            //If any arrows out of bounds remove them else set up the arrows movement
            arrows = arrows.filter(arrowUpdatePos);
            //console.log(arrows.length);

            //Else the arrow is in the canvas so update the position
            for (i = 0; i < arrows.length; i++) {
                arrows[i][0] = arrows[i][0] + velx_arr;
                bullet(arrows[i][0],arrows[i][1]);
            }

            //Setting up the badguys movement based on a timer which increases the frequency 
            // of their occurence with time
            if(frame<80)
                Objective();

            if(badtimer == 0)
            {
                //console.log("lala");
                badguys.push([canvas.width,60 + (Math.random() * 5)*100])
                badtimer = 100 - (badtimer1*2);
                if(badtimer1 >=35)
                    badtimer1 = 35;
                else
                    {
                        badtimer1 += 5;
                        player_vel += 3;
                    }
            }
            
            //No. of actors that passed by our charechter and thus damage its health in a random manner

            var crossed = badguys.filter(badgerAttacked);
            badguys = badguys.filter(badgerUpdatePos);
            console.log(healthvalue);

            for (i = 0; i < crossed.length; i++) {
                healthvalue -= (5+Math.random() * 20);
            }
            
            //Setting up the movement of Badgers
            var index = 0;
            for (i = 0; i < badguys.length; i++) {
                badguys[i][0] -= 7;
            }

            //Displaying all the Badgers
            for (i = 0; i < badguys.length; i++) {
                badBadger(badguys[i][0],badguys[i][1]);
            }
            badtimer -= 1;
        
            //badBadger(200,200);
            //canvas.drawRectangle(200,200,60,30);
            //Bounding Box dimensions of Badger
            

            //Collision check of the arrow and the Badger
            for (var arrow in arrows)
            {
                for(var guy in badguys)
                {
                    console.log(badguys[0][1]);
                    if(arrows[arrow][1] < badguys[guy][1] + 30 && arrows[arrow][1] > badguys[guy][1])
                    {
                        if(arrows[arrow][0] >= badguys[guy][0])
                        {
                            delete badguys[guy];
                            arrows.pop(arrow);
                            acc[0] += 1;
                        }
                        else
                        {
                            continue;
                        }
                    }
                    else
                    {
                        continue;
                    }
                }
            }
            //collision check ends here




            if(frame*timeStep*5 >= 190000)         //Condition for if time runs out
            {
                running = 0;
                exitcode = 1;
            }
            if(healthvalue<=0)                      //Condition for if health goes to zero
            {
                running = 0;
                exitcode = 0;
            }
            if(acc[1] != 0)                         //Calculation of accuracy
            {
                accuracy = (acc[0] * 1.0 )/(acc[1]) * 100;
            }
        frame++;
        }

        //When not running that means game is finished 
        //Exitcode = 0 means Loss
        //ExitCode = 1 means Victory
        else if(!running)
        {
            canvas.update();
            //canvas.clear();
            if(exitcode == 0)
            {
                canvas.setDrawMode('fill');
                canvas.setColor('black');
                canvas.drawRectangle(canvas.width/2 - 400,canvas.height/2 - 140,800,150);
                canvas.setDrawMode('stroke');
                gameover(0,0);
                canvas.drawText(canvas.width/2 - 310,canvas.height/2 + 55,"Accuracy :" + accuracy + "%",50);
            }
            else if(exitcode == 1)
            {
                canvas.setDrawMode('fill');
                canvas.setColor('black');
                canvas.drawRectangle(canvas.width/2 - 400,canvas.height/2 - 140,800,150);
                canvas.setDrawMode('stroke');
                youwin(0,0);
                canvas.drawText(canvas.width/2 - 310,canvas.height/2 + 55,"Accuracy :" + accuracy + "%",50);
            }
            //canvas.clear();
            
            
        }
     }
    // Override functions here; 
    canvas.mainFunction = main;
    

    //If my n is one I override only the Keyboard controller else I override the Mouse controller
    function controller(n)
    {
        if(n==1)
        {
        canvas.keyDownCallback = function(e) {
		//  Key number 38 is the up arrow, 40 is down arrow
		//  Simply Google these things
        if (e.which == 38) {                //Up
            player_y -= player_vel;
            if(player_y<=0)
                player_y = 0;
        } 
        else if (e.which == 37) {               //Left
            player_x -= player_vel;
            if(player_x<=0)
                player_x = 0;
        } 
        else if (e.which == 39) {               //Right
            player_x += player_vel;
            if(player_x>=canvas.width-25)
                player_x = canvas.width-25;
        } 
        else if (e.which == 40) {           //Down
            player_y += player_vel;
            if(player_y>=canvas.height-25)
                player_y = canvas.height-25;
        }
        else if(e.which == 32) {   
            acc[1] += 1;             //arrow
            arrows.push([player_x+20,player_y+25]);
        }
	};
    }
    else{
    canvas.mouseDownCallback = function() {
            acc[1] += 1;                            //arrow
            arrows.push([canvas.mouseX+20,canvas.mouseY+25]);
    }
    }
    }
    
    var timeStep = 5;
    canvas.startMain(timeStep);


    
</script>



